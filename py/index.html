<!doctype HTML>
<style>
pre {
  margin: 0;
}
#error {
  color: red;
}
.container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}
#connected {
  display: flex;
  gap: 1em;
  margin: 0.5em 0;
}
#connected > div {
  cursor: pointer;
  border: 1px solid black;
  border-radius: 0.3em;
  padding: 0.1em;
}
#connected > div.controlling {
  background: black;
  color: white;
}
</style>

<div class="container">
<pre id="updated"></pre>
<pre id="out"></pre>
<pre id="error"></pre>
<input type="range" id="intensity">
<div id="connected"></div>
<input type="text" id="text">
<pre id="json"></pre>
</div>

<script>

const updated = document.querySelector('#updated');
const out = document.querySelector('#out');
const intensity = document.querySelector('#intensity');
const connected = document.querySelector('#connected');
const text = document.querySelector('#text');
const json = document.querySelector('#json');

async function send(update) {
  const resp = await fetch('/state', {
    method: 'POST',
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(update),
  });
  show(await resp.json());
}

intensity.addEventListener('change', () => {
  send({intensity: intensity.value / 100});
});

text.addEventListener('keyup', e => {
  if (e.key === 'Enter') {
    send(JSON.parse(text.value));
    text.value = '';
  }
});

const ts = () => new Date().toISOString().substring(11, 19);

function show(state) {
  updated.textContent = ts();
  intensity.value = state.intensity * 100;

  while (connected.firstChild) connected.removeChild(connected.firstChild);
  for (const c of state.connected) {
    const div = document.createElement('div');
    div.textContent = c;
    connected.append(div);
    if (c === state.controlling) div.classList.add('controlling');
    div.addEventListener('click', () => {
      send({controlling: c === state.controlling ? null : c});
    });
  }

  json.textContent = JSON.stringify(state, null, 2);
}

async function loop() {
  const resp = await fetch('/state');
  show(await resp.json());
  window.setTimeout(loop, 1000);
}
loop();

window.onerror = window.onunhandledrejection = function() {
  document.querySelector('#error').textContent += `${ts()}\n`;
};

</script>
